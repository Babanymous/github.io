<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BabaForum</title>
    
    <link rel="manifest" href='data:application/manifest+json,{"name":"BabaForum","short_name":"BabaForum","start_url":".","display":"standalone","background_color":"#0f172a","theme_color":"#0f172a","icons":[{"src":"https://cdn-icons-png.flaticon.com/512/1041/1041916.png","sizes":"512x512","type":"image/png"}]}'>
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">

    <script>
        window.onerror = function(msg, url, line) {
            if (msg.includes("ResizeObserver")) return;
            document.body.innerHTML = '<div style="color:red; padding:20px; background:black; font-family:monospace; z-index:10000; position:fixed; top:0; width:100%;"><h1>Error Detected</h1><p>'+msg+'</p><p>Line: '+line+'</p></div>';
        };
    </script>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .glass-panel { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.08); box-shadow: 0 4px 24px -1px rgba(0, 0, 0, 0.2); }
        .glass-input { background: rgba(15, 23, 42, 0.5) !important; border: 1px solid rgba(255, 255, 255, 0.1) !important; backdrop-filter: blur(10px); }
        .glass-input:focus { border-color: #818cf8 !important; outline: none; }
        .btn-primary { background: linear-gradient(135deg, #4f46e5 0%, #9333ea 100%); box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3); }
        .btn-danger { background: rgba(239, 68, 68, 0.15); color: #fca5a5; border: 1px solid rgba(239, 68, 68, 0.3); }
        .btn-outline { border: 1px solid #475569; color: #cbd5e1; }
        .prose img { max-width: 100%; border-radius: 12px; margin: 12px 0; border: 1px solid rgba(255,255,255,0.1); cursor: zoom-in; }
        .badge-base { font-weight: 600; letter-spacing: 0.025em; }
        .badge-new { background: rgba(71, 85, 105, 0.5); color: #e2e8f0; border: 1px solid rgba(255,255,255,0.1); }
        .badge-member { background: rgba(5, 150, 105, 0.2); color: #6ee7b7; border: 1px solid rgba(5, 150, 105, 0.4); }
        .badge-regular { background: rgba(37, 99, 235, 0.2); color: #93c5fd; border: 1px solid rgba(37, 99, 235, 0.4); }
        .badge-legend { background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(180, 83, 9, 0.2)); color: #fcd34d; border: 1px solid rgba(245, 158, 11, 0.5); }
        .fade-in { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const ADMIN_UID = "dqRRlIXKOIaVJDwEsWV1KeOQDgC3"; 
        const firebaseConfig = {
          apiKey: "AIzaSyDycl15CdloFo0LYcWQXwflBTfzscGjAIA",
          authDomain: "babaforum-500b9.firebaseapp.com",
          projectId: "babaforum-500b9",
          storageBucket: "babaforum-500b9.firebasestorage.app",
          messagingSenderId: "428963221608",
          appId: "1:428963221608:web:e284a66da91733d2e0abdd",
          measurementId: "G-F2ZTCCXPR2"
        };

        let app, auth, db;
        try {
            if (firebaseConfig.apiKey !== "YOUR_API_KEY_HERE") {
                app = firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                db = firebase.firestore();
            }
        } catch (e) { console.error("Firebase Init Error:", e); }

        const { useState, useEffect, useRef } = React;

        const getRank = (count) => {
            const base = "badge-base text-[10px] px-2.5 py-1 rounded-full uppercase";
            if (count >= 100) return { label: "Legend", class: `${base} badge-legend` };
            if (count >= 50) return { label: "Regular", class: `${base} badge-regular` };
            if (count >= 10) return { label: "Member", class: `${base} badge-member` };
            return { label: "Newcomer", class: `${base} badge-new` };
        };

        const compressImage = (file) => {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 800; 
                        const scaleSize = MAX_WIDTH / img.width;
                        canvas.width = (scaleSize < 1) ? MAX_WIDTH : img.width;
                        canvas.height = (scaleSize < 1) ? img.height * scaleSize : img.height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        resolve(canvas.toDataURL('image/jpeg', 0.6));
                    }
                }
            });
        };

        const ensureUserProfile = async (user) => {
            if(!user || !db) return;
            const userRef = db.collection('users').doc(user.uid);
            const doc = await userRef.get();
            if (!doc.exists) {
                await userRef.set({
                    displayName: user.displayName,
                    photoURL: user.photoURL,
                    bio: "Just joined BabaForum!",
                    followers: [], following: [], postCount: 0, guilds: [],
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
        };

        function SetupScreen() {
            return (
                <div className="min-h-screen flex items-center justify-center p-4 bg-slate-900">
                    <div className="glass-panel p-8 rounded-2xl text-center fade-in">
                        <h1 className="text-2xl font-bold text-white mb-2">Setup Required</h1>
                        <p className="text-slate-400 mb-6">Please add your Firebase Keys to index.html</p>
                        <button onClick={() => window.location.reload()} className="btn-primary text-white px-6 py-2 rounded-lg">Refresh</button>
                    </div>
                </div>
            );
        }

        function Lightbox({ src, onClose }) {
            return (
                <div className="fixed inset-0 bg-black/95 z-[9999] flex items-center justify-center p-4 cursor-pointer fade-in" onClick={onClose}>
                    <img src={src} className="max-w-full max-h-full rounded-2xl shadow-2xl cursor-default" onClick={e => e.stopPropagation()} />
                    <button className="absolute top-4 right-4 text-white text-3xl hover:text-red-500 bg-black/50 rounded-full w-10 h-10 flex items-center justify-center"><i className="fa-solid fa-xmark"></i></button>
                </div>
            );
        }

        function RichText({ content }) {
            const [zoomImg, setZoomImg] = useState(null);
            const handleClick = (e) => { if (e.target.tagName === 'IMG') setZoomImg(e.target.src); };
            const getMarkdownText = () => {
                if (!window.marked) return { __html: content };
                const safeText = content.replace(/</g, "&lt;").replace(/>/g, "&gt;"); 
                return { __html: marked.parse(safeText) };
            };
            return (
                <>
                    <div className="prose text-slate-300 text-sm leading-relaxed" dangerouslySetInnerHTML={getMarkdownText()} onClick={handleClick} />
                    {zoomImg && <Lightbox src={zoomImg} onClose={() => setZoomImg(null)} />}
                </>
            );
        }

        function LikeButton({ user, docId, collection, likes, likedBy, authorId }) {
            const [isLiked, setIsLiked] = useState(false);
            const [count, setCount] = useState(likes || 0);
            useEffect(() => { if (user && likedBy?.includes(user.uid)) setIsLiked(true); }, [user, likedBy]);
            const handleLike = async (e) => {
                e.stopPropagation();
                if (!user) return alert("Please sign in to vote!");
                const docRef = db.collection(collection).doc(docId);
                const newStatus = !isLiked;
                setIsLiked(newStatus);
                setCount(prev => newStatus ? prev + 1 : prev - 1);
                try {
                    const batch = db.batch();
                    batch.update(docRef, {
                        likes: firebase.firestore.FieldValue.increment(newStatus ? 1 : -1),
                        likedBy: newStatus ? firebase.firestore.FieldValue.arrayUnion(user.uid) : firebase.firestore.FieldValue.arrayRemove(user.uid)
                    });
                    if (newStatus && authorId && authorId !== user.uid) {
                        batch.set(db.collection('notifications').doc(), {
                            toUserId: authorId, fromName: user.displayName, message: "liked your post", createdAt: firebase.firestore.FieldValue.serverTimestamp(), read: false
                        });
                    }
                    await batch.commit();
                } catch (error) { setIsLiked(!newStatus); setCount(prev => newStatus ? prev - 1 : prev + 1); }
            };
            return (
                <button onClick={handleLike} className={`flex items-center gap-1 px-2 py-1 rounded-md transition-colors ${isLiked ? 'text-pink-500 bg-pink-500/10' : 'text-slate-500 hover:bg-slate-700'}`}>
                    <i className={`${isLiked ? 'fa-solid' : 'fa-regular'} fa-heart`}></i><span className="text-xs font-bold">{count > 0 ? count : ''}</span>
                </button>
            );
        }

        function ImageUpload({ onUpload }) {
            const [uploading, setUploading] = useState(false);
            const handleFile = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                setUploading(true);
                try { const b64 = await compressImage(file); onUpload(b64); } catch (e) { alert(e.message); } finally { setUploading(false); }
            };
            return (
                <label className="cursor-pointer text-slate-400 hover:text-indigo-400 flex items-center gap-2 text-sm font-medium transition-colors py-2">
                    <input type="file" accept="image/*" className="hidden" onChange={handleFile} disabled={uploading} />
                    {uploading ? <i className="fa-solid fa-spinner fa-spin"></i> : <i className="fa-regular fa-image text-lg"></i>}
                    {uploading ? "Processing..." : "Add Image"}
                </label>
            );
        }

        function InstallButton() {
            const [deferredPrompt, setDeferredPrompt] = useState(null);
            const [isIOS, setIsIOS] = useState(false);
            const [showIOSHelp, setShowIOSHelp] = useState(false);
            useEffect(() => {
                window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); setDeferredPrompt(e); });
                const isIosDevice = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
                if(isIosDevice && !window.navigator.standalone) setIsIOS(true);
            }, []);
            const handleInstall = async () => {
                if (deferredPrompt) { deferredPrompt.prompt(); const { outcome } = await deferredPrompt.userChoice; if (outcome === 'accepted') setDeferredPrompt(null); }
                else if (isIOS) { setShowIOSHelp(true); }
                else { alert("To install: Tap your browser's Menu button (‚ãÆ) and select 'Add to Home Screen'."); }
            };
            return (
                <>
                    <button onClick={handleInstall} className="text-slate-400 hover:text-indigo-400 p-2 relative group"><i className="fa-solid fa-download text-xl"></i></button>
                    {showIOSHelp && (
                        <div className="fixed inset-0 bg-black/90 z-[10000] flex items-center justify-center p-6" onClick={() => setShowIOSHelp(false)}>
                            <div className="glass-panel p-6 rounded-2xl text-center max-w-sm" onClick={e => e.stopPropagation()}>
                                <h3 className="text-xl font-bold text-white mb-4">Install on iPhone</h3>
                                <p className="text-slate-300 mb-4">1. Tap the <i className="fa-solid fa-arrow-up-from-bracket mx-1"></i> <strong>Share</strong> button in your browser bar.</p>
                                <p className="text-slate-300 mb-6">2. Scroll down and tap <strong>Add to Home Screen</strong>.</p>
                                <button onClick={() => setShowIOSHelp(false)} className="btn-primary w-full py-2 rounded-lg">Got it</button>
                            </div>
                        </div>
                    )}
                </>
            );
        }

        function Notifications({ user, onClose }) {
            const [notes, setNotes] = useState([]);
            useEffect(() => {
                const unsub = db.collection('notifications').where('toUserId', '==', user.uid).orderBy('createdAt', 'desc').limit(20)
                    .onSnapshot(snap => setNotes(snap.docs.map(d => ({id: d.id, ...d.data()}))));
                return () => unsub();
            }, [user]);
            const markRead = (id) => db.collection('notifications').doc(id).update({ read: true });
            return (
                <div className="absolute top-16 right-0 w-96 glass-panel rounded-2xl shadow-2xl overflow-hidden z-50 fade-in">
                    <div className="p-4 bg-slate-900/50 border-b border-white/10 flex justify-between items-center"><h3 className="font-bold text-white">Notifications</h3><button onClick={onClose}><i className="fa-solid fa-xmark text-slate-400"></i></button></div>
                    <div className="max-h-[400px] overflow-y-auto">
                        {notes.length === 0 && <div className="p-8 text-center text-slate-500">No new notifications.</div>}
                        {notes.map(n => (
                            <div key={n.id} onClick={() => markRead(n.id)} className={`p-4 border-b border-white/5 cursor-pointer transition-colors flex gap-3 items-start ${n.read ? 'hover:bg-slate-800/50 opacity-70' : 'bg-indigo-500/10 hover:bg-indigo-500/20'}`}>
                                <div className="w-8 h-8 rounded-full bg-indigo-500/20 flex items-center justify-center text-indigo-400 shrink-0"><i className="fa-solid fa-bell"></i></div>
                                <div>
                                    <p className="text-slate-200 text-sm"><span className="font-bold text-indigo-300">{n.fromName}</span> {n.message}</p>
                                    <div className="text-xs text-slate-500 mt-1.5">{n.createdAt ? new Date(n.createdAt.seconds * 1000).toLocaleTimeString() : 'Just now'}</div>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        }

        function Navbar({ user, onViewChange, onOpenAdmin, setViewUserId }) {
            const [showNotes, setShowNotes] = useState(false);
            const [unreadCount, setUnreadCount] = useState(0);
            const isAdmin = user && user.uid === ADMIN_UID;
            useEffect(() => {
                if(!user) return;
                const unsub = db.collection('notifications').where('toUserId', '==', user.uid).where('read', '==', false).onSnapshot(snap => setUnreadCount(snap.size));
                return () => unsub();
            }, [user]);
            const handleLogin = () => { if (!auth) return alert("Config Error"); auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()).catch(e => alert(e.message)); };
            return (
                <nav className="glass-panel sticky top-0 z-50 border-b-0 shadow-sm backdrop-blur-xl">
                    <div className="max-w-6xl mx-auto px-4 h-20 flex items-center justify-between">
                        <div className="flex items-center gap-3 cursor-pointer group" onClick={() => onViewChange('home')}>
                            <span className="text-2xl font-extrabold bg-clip-text text-transparent bg-gradient-to-r from-white via-indigo-200 to-slate-400 tracking-tight">BabaForum</span>
                        </div>
                        <div className="flex items-center gap-4">
                            <button onClick={()=>onViewChange('guilds')} className="text-slate-400 hover:text-white hidden md:block"><i className="fa-solid fa-users-rectangle mr-1"></i> Guilds</button>
                            <InstallButton />
                            {user ? (
                                <>
                                    {isAdmin && <button onClick={onOpenAdmin} className="text-amber-400 hover:text-amber-300 transition-colors bg-amber-500/10 p-2 rounded-lg"><i className="fa-solid fa-shield-halved"></i></button>}
                                    <div className="relative">
                                        <button onClick={() => setShowNotes(!showNotes)} className="text-slate-400 hover:text-white relative p-2 transition-colors">
                                            <i className="fa-regular fa-bell text-xl"></i>
                                            {unreadCount > 0 && <span className="absolute top-0 right-0 bg-red-500 text-white text-[10px] font-bold w-5 h-5 rounded-full flex items-center justify-center border-2 border-slate-900">{unreadCount}</span>}
                                        </button>
                                        {showNotes && <Notifications user={user} onClose={() => setShowNotes(false)} />}
                                    </div>
                                    <button onClick={() => { setViewUserId(user.uid); onViewChange('profile'); }} className="w-10 h-10 rounded-full overflow-hidden border-2 border-slate-700/50 hover:border-indigo-500 transition-all ring-2 ring-transparent hover:ring-indigo-500/30 shadow-md"><img src={user.photoURL} className="w-full h-full object-cover"/></button>
                                    <button onClick={() => auth.signOut()} className="text-slate-400 hover:text-red-400 p-2 transition-colors"><i className="fa-solid fa-right-from-bracket text-lg"></i></button>
                                </>
                            ) : <button onClick={handleLogin} className="btn-primary text-white px-6 py-2.5 rounded-xl font-bold text-sm tracking-wide shadow-lg">Sign In</button>}
                        </div>
                    </div>
                </nav>
            );
        }

        function AdminDashboard({ onClose }) {
            const [stats, setStats] = useState({ topics: 0, replies: 0 });
            const [loading, setLoading] = useState(true);
            const [cleaning, setCleaning] = useState(false);
            useEffect(() => {
                const fetchStats = async () => {
                    const t = await db.collection('topics').get();
                    const r = await db.collection('replies').get();
                    setStats({ topics: t.size, replies: r.size });
                    setLoading(false);
                };
                fetchStats();
            }, []);
            const recountUserPosts = async () => {
                if(!confirm("Recalculate ALL user post counts?")) return;
                setCleaning(true);
                try {
                    const topicsSnap = await db.collection('topics').get();
                    const userCounts = {};
                    topicsSnap.forEach(doc => { const uid = doc.data().authorId; if(uid) userCounts[uid] = (userCounts[uid] || 0) + 1; });
                    const usersSnap = await db.collection('users').get();
                    const batch = db.batch();
                    usersSnap.forEach(doc => { const realCount = userCounts[doc.id] || 0; batch.update(doc.ref, { postCount: realCount }); });
                    await batch.commit();
                    alert("Success! User counts fixed.");
                } catch(e) { alert(e.message); }
                setCleaning(false);
            };
            const runCleanup = async () => {
                if(!confirm("Delete topics > 1 year old?")) return;
                setCleaning(true);
                try {
                    const date = new Date(); date.setFullYear(date.getFullYear()-1);
                    const snap = await db.collection('topics').where('createdAt', '<', date).limit(50).get();
                    const batch = db.batch();
                    for(const d of snap.docs) {
                        batch.delete(d.ref);
                        const userRef = db.collection('users').doc(d.data().authorId);
                        batch.update(userRef, { postCount: firebase.firestore.FieldValue.increment(-1) });
                        const rs = await db.collection('replies').where('topicId','==',d.id).get();
                        rs.forEach(r => batch.delete(r.ref));
                    }
                    await batch.commit();
                    alert(`Pruned ${snap.size} topics.`);
                } catch(e) { alert(e.message); }
                setCleaning(false);
            };
            return (
                <div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4 fade-in">
                    <div className="glass-panel p-8 rounded-3xl max-w-md w-full relative shadow-2xl">
                        <button onClick={onClose} className="absolute top-5 right-5 text-slate-400 hover:text-white bg-slate-800/50 p-2 rounded-full"><i className="fa-solid fa-xmark text-lg"></i></button>
                        <h2 className="text-2xl font-bold text-white mb-8 flex items-center"><i className="fa-solid fa-shield-halved text-amber-400 mr-3"></i> Admin Panel</h2>
                        {loading ? <p className="text-slate-400">Loading...</p> : (
                            <div className="space-y-8">
                                <div className="grid grid-cols-2 gap-4">
                                    <div className="bg-slate-900/50 p-6 rounded-2xl text-center border border-white/5"><div className="text-4xl font-extrabold text-white mb-1">{stats.topics}</div><div className="text-xs text-slate-400 font-bold uppercase tracking-wider">Topics</div></div>
                                    <div className="bg-slate-900/50 p-6 rounded-2xl text-center border border-white/5"><div className="text-4xl font-extrabold text-white mb-1">{stats.replies}</div><div className="text-xs text-slate-400 font-bold uppercase tracking-wider">Replies</div></div>
                                </div>
                                <div className="border-t border-white/10 pt-8 space-y-4">
                                    <h3 className="text-sm font-bold text-slate-400 uppercase tracking-wider mb-4">Database Maintenance</h3>
                                    <button onClick={recountUserPosts} disabled={cleaning} className="w-full btn-primary py-3 rounded-xl font-bold text-sm flex items-center justify-center gap-2 shadow-lg">{cleaning?<i className="fa-solid fa-spinner fa-spin"></i>:<i className="fa-solid fa-rotate"></i>} Fix User Counts</button>
                                    <button onClick={runCleanup} disabled={cleaning} className="w-full btn-danger py-3 rounded-xl font-bold text-sm flex items-center justify-center gap-2">{cleaning?<i className="fa-solid fa-spinner fa-spin"></i>:<i className="fa-solid fa-calendar-xmark"></i>} Prune Old Topics</button>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        function CreateGuild({ user, onViewChange }) {
            const [form, setForm] = useState({ name: '', description: '', icon: '' });
            const handleSubmit = async (e) => {
                e.preventDefault();
                await db.collection('guilds').add({
                    ...form, createdBy: user.uid, memberCount: 1, createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                const guildSnap = await db.collection('guilds').where('name', '==', form.name).get();
                if(!guildSnap.empty) {
                    const guildId = guildSnap.docs[0].id;
                    await db.collection('users').doc(user.uid).update({ guilds: firebase.firestore.FieldValue.arrayUnion(guildId) });
                }
                onViewChange('guilds');
            };
            return (
                <div className="max-w-2xl mx-auto p-4 fade-in">
                    <button onClick={()=>onViewChange('guilds')} className="text-slate-400 mb-4"><i className="fa-solid fa-arrow-left"></i> Back</button>
                    <div className="glass-panel p-8 rounded-2xl">
                        <h2 className="text-2xl font-bold text-white mb-6">Create Guild</h2>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <input className="w-full glass-input rounded-lg p-3 text-white" placeholder="Guild Name" value={form.name} onChange={e=>setForm({...form, name:e.target.value})} required />
                            <input className="w-full glass-input rounded-lg p-3 text-white" placeholder="Icon Emoji (e.g. üéÆ)" value={form.icon} onChange={e=>setForm({...form, icon:e.target.value})} required />
                            <textarea className="w-full glass-input rounded-lg p-3 text-white" placeholder="Description" value={form.description} onChange={e=>setForm({...form, description:e.target.value})} required />
                            <button type="submit" className="w-full btn-primary text-white py-3 rounded-xl font-bold">Create</button>
                        </form>
                    </div>
                </div>
            );
        }

        function GuildList({ user, onViewChange, setSelectedGuild }) {
            const [guilds, setGuilds] = useState([]);
            const [myGuilds, setMyGuilds] = useState([]);
            
            useEffect(() => {
                db.collection('guilds').orderBy('memberCount', 'desc').onSnapshot(s => setGuilds(s.docs.map(d=>({id:d.id,...d.data()}))));
                if(user) db.collection('users').doc(user.uid).onSnapshot(d => setMyGuilds(d.data()?.guilds || []));
            }, [user]);

            const toggleJoin = async (e, guildId) => {
                e.stopPropagation(); if(!user) return alert("Sign in!");
                const isMember = myGuilds.includes(guildId);
                const batch = db.batch();
                const uRef = db.collection('users').doc(user.uid);
                const gRef = db.collection('guilds').doc(guildId);
                if(isMember) {
                    batch.update(uRef, { guilds: firebase.firestore.FieldValue.arrayRemove(guildId) });
                    batch.update(gRef, { memberCount: firebase.firestore.FieldValue.increment(-1) });
                } else {
                    batch.update(uRef, { guilds: firebase.firestore.FieldValue.arrayUnion(guildId) });
                    batch.update(gRef, { memberCount: firebase.firestore.FieldValue.increment(1) });
                }
                await batch.commit();
            };

            return (
                <div className="max-w-5xl mx-auto p-4 fade-in space-y-6">
                    <div className="flex justify-between items-center">
                        <h2 className="text-3xl font-bold text-white">Guilds</h2>
                        {user && <button onClick={()=>onViewChange('createGuild')} className="btn-primary text-white px-4 py-2 rounded-lg"><i className="fa-solid fa-plus"></i> Create</button>}
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        {guilds.map(g => (
                            <div key={g.id} onClick={()=>{setSelectedGuild(g); onViewChange('home');}} className="glass-panel p-5 rounded-xl cursor-pointer hover:bg-slate-800 transition-colors relative group">
                                <div className="flex justify-between items-start mb-2">
                                    <div className="text-4xl">{g.icon || 'üõ°Ô∏è'}</div>
                                    <button onClick={(e)=>toggleJoin(e,g.id)} className={`px-3 py-1 rounded text-xs font-bold ${myGuilds.includes(g.id) ? 'bg-slate-700 text-slate-300' : 'btn-primary text-white'}`}>{myGuilds.includes(g.id) ? 'Joined' : 'Join'}</button>
                                </div>
                                <h3 className="text-xl font-bold text-white">{g.name}</h3>
                                <p className="text-slate-400 text-sm mt-1 line-clamp-2">{g.description}</p>
                                <div className="mt-3 text-xs text-slate-500 font-bold uppercase">{g.memberCount || 0} Members</div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        }

        function ProfileView({ viewUserId, currentUser, onViewChange, setCurrentTopic }) {
            const [profile, setProfile] = useState(null);
            const [posts, setPosts] = useState([]);
            const [isFollowing, setIsFollowing] = useState(false);
            const [editing, setEditing] = useState(false);
            const [newName, setNewName] = useState("");
            const [newBio, setNewBio] = useState("");
            useEffect(() => {
                const load = async () => {
                    if(!viewUserId) return;
                    const d = await db.collection('users').doc(viewUserId).get();
                    if(d.exists) {
                        const data = d.data(); setProfile(data); setNewName(data.displayName); setNewBio(data.bio||"");
                        if(currentUser) { const my = await db.collection('users').doc(currentUser.uid).get(); setIsFollowing(my.data().following?.includes(viewUserId)); }
                    }
                    try {
                        const snap = await db.collection('topics').where('authorId','==',viewUserId).orderBy('createdAt','desc').limit(20).get();
                        setPosts(snap.docs.map(d=>({id:d.id,...d.data()})));
                    } catch(e) { if(e.message.includes("index")) console.warn("Missing Index"); }
                };
                if(db && viewUserId) load();
            }, [viewUserId, currentUser]);
            const toggleFollow = async () => {
                if(!currentUser) return alert("Sign in!");
                const my = db.collection('users').doc(currentUser.uid); const th = db.collection('users').doc(viewUserId); const b = db.batch();
                if(isFollowing) { b.update(my,{following:firebase.firestore.FieldValue.arrayRemove(viewUserId)}); b.update(th,{followers:firebase.firestore.FieldValue.arrayRemove(currentUser.uid)}); }
                else { b.update(my,{following:firebase.firestore.FieldValue.arrayUnion(viewUserId)}); b.update(th,{followers:firebase.firestore.FieldValue.arrayUnion(currentUser.uid)}); b.set(db.collection('notifications').doc(), {toUserId:viewUserId, fromName:currentUser.displayName, message:"followed you", createdAt:firebase.firestore.FieldValue.serverTimestamp(), read:false}); }
                await b.commit(); setIsFollowing(!isFollowing); setProfile(p=>({...p, followers: isFollowing?p.followers.slice(0,-1):[...(p.followers||[]),currentUser.uid]}));
            };
            const save = async () => { await db.collection('users').doc(currentUser.uid).update({displayName:newName, bio:newBio}); setProfile(p=>({...p, displayName:newName, bio:newBio})); setEditing(false); };
            if(!profile) return <div className="text-center p-20 text-slate-500"><i className="fa-solid fa-spinner fa-spin text-3xl mb-4"></i><p>Loading Profile...</p></div>;
            const isMe = currentUser && currentUser.uid === viewUserId;
            const rank = getRank(profile.postCount || 0);
            return (
                <div className="max-w-4xl mx-auto p-6 fade-in">
                    <button onClick={()=>onViewChange('home')} className="text-slate-400 hover:text-white mb-8 flex gap-2 items-center font-medium transition-colors"><i className="fa-solid fa-arrow-left"></i> Back to Feed</button>
                    <div className="glass-panel p-10 rounded-3xl mb-10 flex flex-col md:flex-row items-center gap-8 text-center md:text-left shadow-xl relative overflow-hidden">
                        <div className="absolute inset-0 bg-gradient-to-br from-indigo-500/10 to-purple-500/10 z-0"></div>
                        <img src={profile.photoURL} className="w-32 h-32 rounded-full border-4 border-white/10 shadow-2xl relative z-10"/>
                        <div className="flex-1 relative z-10">
                            {editing ? (
                                <div className="space-y-4 bg-slate-900/50 p-6 rounded-2xl border border-white/10">
                                    <h3 className="text-white font-bold mb-4">Edit Profile</h3>
                                    <input className="w-full glass-input rounded-xl p-3 text-white font-bold" value={newName} onChange={e=>setNewName(e.target.value)} placeholder="Display Name"/>
                                    <textarea className="w-full glass-input rounded-xl p-3 text-white resize-none" rows="3" value={newBio} onChange={e=>setNewBio(e.target.value)} placeholder="Tell us about yourself..."/>
                                    <div className="flex gap-3 justify-end pt-2">
                                        <button onClick={()=>setEditing(false)} className="btn-outline px-5 py-2 rounded-xl text-sm font-bold">Cancel</button>
                                        <button onClick={save} className="btn-primary px-6 py-2 rounded-xl text-white text-sm font-bold">Save Changes</button>
                                    </div>
                                </div>
                            ) : (
                                <>
                                    <div className="flex flex-col md:flex-row items-center justify-center md:justify-start gap-3 mb-2">
                                        <h1 className="text-4xl font-extrabold text-white tracking-tight">{profile.displayName}</h1>
                                        <span className={rank.class}>{rank.label}</span>
                                    </div>
                                    <p className="text-indigo-200 text-lg mb-6 leading-relaxed max-w-2xl">{profile.bio}</p>
                                    <div className="flex gap-8 justify-center md:justify-start text-sm text-slate-400 mb-6 bg-slate-900/30 p-4 rounded-2xl inline-flex border border-white/5">
                                        <div className="text-center"><strong className="text-white text-xl block">{profile.followers?.length||0}</strong> Followers</div>
                                        <div className="text-center"><strong className="text-white text-xl block">{profile.following?.length||0}</strong> Following</div>
                                        <div className="text-center"><strong className="text-white text-xl block">{profile.postCount||0}</strong> Posts</div>
                                    </div>
                                    <div>{isMe ? <button onClick={()=>setEditing(true)} className="btn-outline px-6 py-2.5 rounded-xl text-sm font-bold shadow-sm">Edit Profile</button> : <button onClick={toggleFollow} className={`px-8 py-2.5 rounded-xl font-bold shadow-lg transition-all ${isFollowing?'bg-slate-700 text-slate-300 hover:bg-slate-600':'btn-primary text-white'}`}>{isFollowing?'Following':'Follow'}</button>}</div>
                                </>
                            )}
                        </div>
                    </div>
                    <h3 className="text-xl font-bold text-white mb-6 flex items-center gap-2"><i className="fa-solid fa-clock-rotate-left text-indigo-400"></i> Recent Activity</h3>
                    <div className="grid gap-4 md:grid-cols-2">
                        {posts.map(p => (
                            <div key={p.id} onClick={() => { setCurrentTopic(p); onViewChange('thread'); }} className="glass-panel glass-hover p-5 rounded-2xl flex gap-4 items-center transition-all hover:scale-[1.02] cursor-pointer">
                                <div className="w-16 h-16 bg-slate-800/50 rounded-xl overflow-hidden flex-shrink-0 border border-white/5 relative">
                                    {p.topicImage ? <img src={p.topicImage} className="w-full h-full object-cover"/> : <div className="w-full h-full flex items-center justify-center text-slate-500"><i className="fa-regular fa-file-lines text-2xl"></i></div>}
                                </div>
                                <div className="flex-1 min-w-0">
                                    <h4 className="text-base font-bold text-slate-200 truncate mb-1">{p.title}</h4>
                                    <div className="text-indigo-300 text-xs font-medium">{new Date(p.createdAt?.seconds*1000).toLocaleDateString()}</div>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        }

        function ThreadView({ user, topic, onViewChange, setViewUserId }) {
            const [replies, setReplies] = useState([]);
            const [newReply, setNewReply] = useState('');
            const bottomRef = useRef(null);
            const isAdmin = user && user.uid === ADMIN_UID;
            useEffect(() => { if(!topic) return; const u = db.collection('replies').where('topicId','==',topic.id).orderBy('createdAt','asc').onSnapshot(s => setReplies(s.docs.map(d=>({id:d.id, ...d.data()})))); return ()=>u(); }, [topic]);
            const postReply = async (e) => {
                e.preventDefault(); if(!newReply.trim()) return;
                const batch = db.batch();
                const uRef = db.collection('users').doc(user.uid);
                const uDoc = await uRef.get();
                const userData = uDoc.data();
                const realName = userData.displayName || user.displayName;
                const cnt = (userData.postCount||0)+1;
                batch.update(uRef,{postCount:cnt});
                batch.set(db.collection('replies').doc(), { content: newReply, topicId: topic.id, authorId: user.uid, authorName: realName, authorPhoto: user.photoURL, authorRank: getRank(cnt).label, createdAt: firebase.firestore.FieldValue.serverTimestamp(), likes: 0, likedBy: [] });
                batch.update(db.collection('topics').doc(topic.id), { replyCount: firebase.firestore.FieldValue.increment(1) });
                if(topic.authorId!==user.uid) batch.set(db.collection('notifications').doc(), { toUserId: topic.authorId, fromName: realName, message: "replied to your topic", createdAt: firebase.firestore.FieldValue.serverTimestamp(), read: false });
                await batch.commit(); setNewReply(''); setTimeout(()=>bottomRef.current?.scrollIntoView({behavior:'smooth'}),100);
            };
            const handleImageInsert = (url) => setNewReply(p => p + `\n![Image](${url})\n`);
            const deleteReply = async (id) => { if(confirm("Delete?")) { const b = db.batch(); b.delete(db.collection('replies').doc(id)); b.update(db.collection('topics').doc(topic.id), {replyCount: firebase.firestore.FieldValue.increment(-1)}); await b.commit(); }};
            return (
                <div className="max-w-4xl mx-auto p-6 h-[calc(100vh-80px)] flex flex-col fade-in">
                    <button onClick={() => onViewChange('home')} className="text-slate-400 mb-4 w-fit flex items-center gap-2 font-medium transition-colors"><i className="fa-solid fa-arrow-left"></i> Back to Feed</button>
                    <div className="flex-1 overflow-y-auto space-y-6 pr-4 pb-6 custom-scrollbar">
                        <div className="glass-panel p-8 rounded-3xl shadow-xl relative overflow-hidden">
                            <div className="absolute top-0 left-0 w-full h-1.5 bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500"></div>
                            <div className="flex items-center gap-4 mb-6">
                                <img src={topic.authorPhoto} className="w-14 h-14 rounded-full border-2 border-indigo-500/30 shadow-sm cursor-pointer hover:ring-2 ring-indigo-500 transition-all" onClick={()=>{setViewUserId(topic.authorId);onViewChange('profile')}}/>
                                <div>
                                    <div className="text-lg font-bold text-white cursor-pointer hover:text-indigo-300 transition-colors" onClick={()=>{setViewUserId(topic.authorId);onViewChange('profile')}}>{topic.authorName}</div>
                                    <span className={topic.authorRank.class}>{topic.authorRank.label}</span>
                                </div>
                                <div className="ml-auto text-sm text-slate-500 font-medium">{topic.createdAt ? new Date(topic.createdAt.seconds*1000).toLocaleDateString() : ''}</div>
                            </div>
                            <h1 className="text-3xl font-extrabold text-white mb-6 tracking-tight">{topic.title}</h1>
                            <RichText content={topic.content} />
                            <div className="mt-8 pt-4 border-t border-white/10 flex items-center gap-4">
                                <LikeButton user={user} docId={topic.id} collection="topics" likes={topic.likes} likedBy={topic.likedBy} authorId={topic.authorId} />
                                <span className="text-slate-400 text-sm font-medium"><i className="fa-regular fa-comment-dots mr-2"></i> {topic.replyCount} Replies</span>
                            </div>
                        </div>
                        {replies.map(r => (
                            <div key={r.id} className="glass-panel p-6 rounded-2xl flex gap-5 relative group">
                                <img src={r.authorPhoto} className="w-10 h-10 rounded-full cursor-pointer border border-slate-700 hover:border-indigo-500 transition-colors" onClick={()=>{setViewUserId(r.authorId);onViewChange('profile')}}/>
                                <div className="flex-1">
                                    <div className="flex justify-between items-center mb-3">
                                        <div className="flex items-center gap-2">
                                            <span className="text-indigo-300 font-bold cursor-pointer hover:underline" onClick={()=>{setViewUserId(r.authorId);onViewChange('profile')}}>{r.authorName}</span>
                                            <span className={r.authorRank.class}>{r.authorRank.label}</span>
                                        </div>
                                        <div className="flex gap-3 items-center">
                                            <span className="text-xs text-slate-500 font-medium">{r.createdAt ? new Date(r.createdAt.seconds*1000).toLocaleDateString() : ''}</span>
                                            {(isAdmin||user?.uid===r.authorId)&&<button onClick={()=>deleteReply(r.id)} className="text-slate-600 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity"><i className="fa-solid fa-trash text-sm"></i></button>}
                                        </div>
                                    </div>
                                    <RichText content={r.content}/>
                                </div>
                            </div>
                        ))}
                        <div ref={bottomRef}></div>
                    </div>
                    {user && <div className="bg-[#0f172a]/80 backdrop-blur-xl p-4 rounded-3xl border border-white/10 mt-4 shadow-2xl"><div className="mb-3 px-1"><ImageUpload onUpload={handleImageInsert}/></div><form onSubmit={postReply} className="relative"><textarea value={newReply} onChange={e=>setNewReply(e.target.value)} className="w-full glass-input rounded-2xl p-4 pr-14 text-white placeholder-slate-500 resize-none" placeholder="Write a reply..." rows="3"/><button type="submit" className="absolute right-3 bottom-3 w-10 h-10 bg-indigo-500 hover:bg-indigo-600 text-white rounded-xl flex items-center justify-center shadow-lg transition-colors"><i className="fa-solid fa-paper-plane"></i></button></form></div>}
                </div>
            );
        }

        function CreateTopic({ user, onViewChange, selectedGuild }) {
            const [form, setForm] = useState({ title: '', content: '', tag: 'General', guildId: selectedGuild ? selectedGuild.id : null });
            const [submitting, setSubmitting] = useState(false);
            const handleSubmit = async (e) => {
                e.preventDefault();
                setSubmitting(true);
                const imgMatch = form.content.match(/!\[Image\]\((.*?)\)/);
                const topicImage = imgMatch ? imgMatch[1] : null;
                const cleanContent = form.content.replace(/!\[Image\]\(.*?\)/g, '[Image] ');
                const previewText = cleanContent.substring(0, 120) + '...';
                const userRef = db.collection('users').doc(user.uid);
                const userDoc = await userRef.get();
                const userData = userDoc.data();
                const realName = userData.displayName || user.displayName;
                const currentCount = (userData.postCount || 0) + 1;
                await userRef.update({ postCount: currentCount });
                
                await db.collection('topics').add({
                    ...form, 
                    preview: previewText, 
                    topicImage: topicImage, 
                    authorId: user.uid, authorName: realName, authorPhoto: user.photoURL, authorRank: getRank(currentCount).label,
                    guildName: selectedGuild ? selectedGuild.name : null,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(), replyCount: 0, likes: 0, likedBy: [], isPinned: false
                });
                setSubmitting(false);
                onViewChange('home');
            };
            const handleImageInsert = (url) => setForm(prev => ({ ...prev, content: prev.content + `\n![Image](${url})\n` }));
            return (
                <div className="max-w-3xl mx-auto p-6 fade-in">
                    <button onClick={() => onViewChange('home')} className="text-slate-400 hover:text-white mb-6 flex items-center gap-2 font-medium transition-colors"><i className="fa-solid fa-arrow-left"></i> Back</button>
                    <div className="glass-panel p-10 rounded-3xl shadow-xl">
                        <h2 className="text-3xl font-extrabold text-white mb-8 tracking-tight">
                            {selectedGuild ? `New Post in ${selectedGuild.name}` : 'Create New Topic'}
                        </h2>
                        <form onSubmit={handleSubmit} className="space-y-6">
                            <input className="w-full glass-input rounded-xl px-5 py-4 text-white text-lg font-bold placeholder-slate-500" placeholder="Title" value={form.title} onChange={e=>setForm({...form, title:e.target.value})} required />
                            {!selectedGuild && <select className="glass-input rounded-xl px-5 py-3 text-white font-medium" value={form.tag} onChange={e=>setForm({...form, tag:e.target.value})}><option>General</option><option>Help</option><option>Showcase</option><option>Ideas</option></select>}
                            <div><textarea className="w-full h-64 bg-slate-900/30 border border-white/10 rounded-xl p-4 text-white" placeholder="Content..." value={form.content} onChange={e=>setForm({...form, content:e.target.value})} required /><div className="mt-2"><ImageUpload onUpload={handleImageInsert} /></div></div>
                            <button type="submit" disabled={submitting} className="w-full btn-primary text-white py-4 rounded-xl font-bold text-lg shadow-lg">{submitting ? "Publishing..." : "Publish"}</button>
                        </form>
                    </div>
                </div>
            );
        }

        function TopicList({ user, onViewChange, setCurrentTopic, setViewUserId, selectedGuild, setSelectedGuild }) {
            const [topics, setTopics] = useState([]);
            const [loading, setLoading] = useState(true);
            const [search, setSearch] = useState("");
            const [filter, setFilter] = useState('all'); 
            const [followingList, setFollowingList] = useState([]);
            const isAdmin = user && user.uid === ADMIN_UID;

            useEffect(() => {
                if(user && db) db.collection('users').doc(user.uid).get().then(doc => { if(doc.exists) setFollowingList(doc.data().following || []); });
                if(db) {
                    let query = db.collection('topics');
                    if (selectedGuild) {
                        query = query.where('guildId', '==', selectedGuild.id).orderBy('createdAt', 'desc');
                    } else {
                        query = query.orderBy('createdAt', 'desc');
                    }
                    
                    const unsubscribe = query.onSnapshot(snap => {
                        const list = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                        list.sort((a, b) => (b.isPinned ? 1 : 0) - (a.isPinned ? 1 : 0) || b.createdAt - a.createdAt);
                        setTopics(list); setLoading(false);
                    }, err => {
                        console.error(err);
                        if(err.message.includes("index")) {
                            const link = err.message.match(/https:\/\/console\.firebase\.google\.com[^\s]*/);
                            if(link && confirm("Missing Index! Click OK to create it.")) window.open(link[0]);
                        }
                        setLoading(false);
                    });
                    return () => unsubscribe();
                }
            }, [user, selectedGuild]);

            const displayTopics = topics.filter(t => {
                const matchesSearch = t.title.toLowerCase().includes(search.toLowerCase()) || t.content.toLowerCase().includes(search.toLowerCase());
                const matchesFilter = filter === 'all' || (filter === 'following' && followingList.includes(t.authorId));
                return matchesSearch && matchesFilter;
            });

            const goToProfile = (e, uid) => { e.stopPropagation(); setViewUserId(uid); onViewChange('profile'); };
            const deleteTopic = async (e, t) => { e.stopPropagation(); if(confirm("Delete?")) { const b = db.batch(); b.delete(db.collection('topics').doc(t.id)); const userRef = db.collection('users').doc(t.authorId); b.update(userRef, { postCount: firebase.firestore.FieldValue.increment(-1) }); const rs = await db.collection('replies').where('topicId','==',t.id).get(); rs.forEach(r => b.delete(r.ref)); await b.commit(); } };
            const togglePin = async (e, topic) => { e.stopPropagation(); await db.collection('topics').doc(topic.id).update({ isPinned: !topic.isPinned }); };

            return (
                <div className="max-w-5xl mx-auto p-4 fade-in space-y-6">
                    <div className="flex flex-col md:flex-row gap-4 justify-between items-center">
                        <div className="flex gap-4 items-center w-full md:w-auto">
                            {selectedGuild && <button onClick={()=>{setSelectedGuild(null); onViewChange('guilds');}} className="text-slate-400 hover:text-white"><i className="fa-solid fa-arrow-left"></i></button>}
                            <h2 className="text-3xl font-bold text-white">{selectedGuild ? selectedGuild.name : 'Feed'}</h2>
                            {user && !selectedGuild && (<div className="flex bg-slate-800 rounded-lg p-1"><button onClick={()=>setFilter('all')} className={`px-3 py-1 rounded text-sm font-medium ${filter==='all'?'bg-slate-600 text-white':'text-slate-400'}`}>All</button><button onClick={()=>setFilter('following')} className={`px-3 py-1 rounded text-sm font-medium ${filter==='following'?'bg-indigo-500 text-white':'text-slate-400'}`}>Following</button></div>)}
                        </div>
                        <div className="flex gap-3 w-full md:w-auto">
                            <div className="relative flex-1 md:w-64"><i className="fa-solid fa-magnifying-glass absolute left-3 top-3 text-slate-500"></i><input type="text" value={search} onChange={(e) => setSearch(e.target.value)} placeholder="Search..." className="w-full bg-slate-800 border border-slate-700 rounded-xl pl-10 pr-4 py-2 text-white"/></div>
                            {user && <button onClick={() => onViewChange('create')} className="btn-primary text-white px-4 py-2 rounded-xl flex items-center gap-2 whitespace-nowrap"><i className="fa-solid fa-plus"></i> New</button>}
                        </div>
                    </div>
                    {loading ? <div className="text-slate-500 text-center">Loading...</div> : displayTopics.map(topic => (
                        <div key={topic.id} onClick={() => {setCurrentTopic(topic); onViewChange('thread')}} className={`glass-panel p-5 rounded-xl cursor-pointer hover:bg-slate-800/80 flex gap-4 ${topic.isPinned ? 'border-l-4 border-amber-400' : ''}`}>
                            <div onClick={(e)=>goToProfile(e, topic.authorId)} className="flex-shrink-0 pt-1 cursor-pointer hover:opacity-80"><img src={topic.authorPhoto} className="w-10 h-10 rounded-full"/></div>
                            <div className="flex-1 min-w-0">
                                <div className="flex justify-between">
                                    <div className="flex items-center gap-2">
                                        <h3 className="text-lg font-semibold text-slate-200 truncate">{topic.title}</h3>
                                        {topic.isPinned && <i className="fa-solid fa-thumbtack text-amber-400 text-xs"></i>}
                                    </div>
                                    <div className="flex gap-2">
                                        {isAdmin && <button onClick={(e)=>togglePin(e,topic)} className={`text-xs p-2 rounded ${topic.isPinned ? 'text-amber-400' : 'text-slate-600 hover:text-amber-400'}`}><i className="fa-solid fa-thumbtack"></i></button>}
                                        {(isAdmin || user?.uid === topic.authorId) && <button onClick={(e)=>deleteTopic(e,topic)} className="text-slate-500 hover:text-red-400"><i className="fa-solid fa-trash"></i></button>}
                                    </div>
                                </div>
                                {topic.topicImage && (<div className="w-full h-48 bg-slate-900 rounded-lg my-3 overflow-hidden border border-slate-700"><img src={topic.topicImage} className="w-full h-full object-cover" alt="Preview"/></div>)}
                                <div className="text-slate-400 text-sm line-clamp-2 mt-1"><RichText content={topic.preview||""}/></div>
                                <div className="flex items-center gap-4 mt-3 text-xs text-slate-500">
                                    <span className={`text-[10px] px-2 py-0.5 rounded ${getRank(0).class}`}>{topic.authorRank?.label || 'Newcomer'}</span>
                                    <span onClick={(e)=>goToProfile(e, topic.authorId)} className="hover:text-indigo-400 cursor-pointer font-medium">{topic.authorName}</span>
                                    {topic.guildName && <span className="bg-slate-700 px-2 py-0.5 rounded text-slate-300">{topic.guildName}</span>}
                                    <div className="flex items-center gap-3 ml-auto">
                                        <LikeButton user={user} docId={topic.id} collection="topics" likes={topic.likes} likedBy={topic.likedBy} authorId={topic.authorId} />
                                        <span><i className="fa-regular fa-comment-dots"></i> {topic.replyCount||0}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    ))}
                </div>
            );
        }

        function CreateGuild({ user, onViewChange }) {
            const [form, setForm] = useState({ name: '', description: '', icon: '' });
            const handleSubmit = async (e) => {
                e.preventDefault();
                await db.collection('guilds').add({
                    ...form, createdBy: user.uid, memberCount: 1, createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                const guildSnap = await db.collection('guilds').where('name', '==', form.name).get();
                if(!guildSnap.empty) {
                    const guildId = guildSnap.docs[0].id;
                    await db.collection('users').doc(user.uid).update({ guilds: firebase.firestore.FieldValue.arrayUnion(guildId) });
                }
                onViewChange('guilds');
            };
            return (
                <div className="max-w-2xl mx-auto p-4 fade-in">
                    <button onClick={()=>onViewChange('guilds')} className="text-slate-400 mb-4"><i className="fa-solid fa-arrow-left"></i> Back</button>
                    <div className="glass-panel p-8 rounded-2xl">
                        <h2 className="text-2xl font-bold text-white mb-6">Create Guild</h2>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <input className="w-full glass-input rounded-lg p-3 text-white" placeholder="Guild Name" value={form.name} onChange={e=>setForm({...form, name:e.target.value})} required />
                            <input className="w-full glass-input rounded-lg p-3 text-white" placeholder="Icon Emoji (e.g. üéÆ)" value={form.icon} onChange={e=>setForm({...form, icon:e.target.value})} required />
                            <textarea className="w-full glass-input rounded-lg p-3 text-white" placeholder="Description" value={form.description} onChange={e=>setForm({...form, description:e.target.value})} required />
                            <button type="submit" className="w-full btn-primary text-white py-3 rounded-xl font-bold">Create</button>
                        </form>
                    </div>
                </div>
            );
        }

        function GuildList({ user, onViewChange, setSelectedGuild }) {
            const [guilds, setGuilds] = useState([]);
            const [myGuilds, setMyGuilds] = useState([]);
            
            useEffect(() => {
                db.collection('guilds').orderBy('memberCount', 'desc').onSnapshot(s => setGuilds(s.docs.map(d=>({id:d.id,...d.data()}))));
                if(user) db.collection('users').doc(user.uid).onSnapshot(d => setMyGuilds(d.data()?.guilds || []));
            }, [user]);

            const toggleJoin = async (e, guildId) => {
                e.stopPropagation(); if(!user) return alert("Sign in!");
                const isMember = myGuilds.includes(guildId);
                const batch = db.batch();
                const uRef = db.collection('users').doc(user.uid);
                const gRef = db.collection('guilds').doc(guildId);
                if(isMember) {
                    batch.update(uRef, { guilds: firebase.firestore.FieldValue.arrayRemove(guildId) });
                    batch.update(gRef, { memberCount: firebase.firestore.FieldValue.increment(-1) });
                } else {
                    batch.update(uRef, { guilds: firebase.firestore.FieldValue.arrayUnion(guildId) });
                    batch.update(gRef, { memberCount: firebase.firestore.FieldValue.increment(1) });
                }
                await batch.commit();
            };

            return (
                <div className="max-w-5xl mx-auto p-4 fade-in space-y-6">
                    <div className="flex justify-between items-center">
                        <h2 className="text-3xl font-bold text-white">Guilds</h2>
                        {user && <button onClick={()=>onViewChange('createGuild')} className="btn-primary text-white px-4 py-2 rounded-lg"><i className="fa-solid fa-plus"></i> Create</button>}
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        {guilds.map(g => (
                            <div key={g.id} onClick={()=>{setSelectedGuild(g); onViewChange('home');}} className="glass-panel p-5 rounded-xl cursor-pointer hover:bg-slate-800 transition-colors relative group">
                                <div className="flex justify-between items-start mb-2">
                                    <div className="text-4xl">{g.icon || 'üõ°Ô∏è'}</div>
                                    <button onClick={(e)=>toggleJoin(e,g.id)} className={`px-3 py-1 rounded text-xs font-bold ${myGuilds.includes(g.id) ? 'bg-slate-700 text-slate-300' : 'btn-primary text-white'}`}>{myGuilds.includes(g.id) ? 'Joined' : 'Join'}</button>
                                </div>
                                <h3 className="text-xl font-bold text-white">{g.name}</h3>
                                <p className="text-slate-400 text-sm mt-1 line-clamp-2">{g.description}</p>
                                <div className="mt-3 text-xs text-slate-500 font-bold uppercase">{g.memberCount || 0} Members</div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        }

        function App() {
            const [view, setView] = useState('home');
            const [user, setUser] = useState(null);
            const [currentTopic, setCurrentTopic] = useState(null);
            const [viewUserId, setViewUserId] = useState(null);
            const [selectedGuild, setSelectedGuild] = useState(null);
            const [isConfigured, setIsConfigured] = useState(false);
            const [showAdmin, setShowAdmin] = useState(false);

            useEffect(() => {
                if (firebaseConfig.apiKey !== "YOUR_API_KEY_HERE") {
                    setIsConfigured(true);
                    return auth.onAuthStateChanged(async (u) => {
                        if(u) await ensureUserProfile(u);
                        setUser(u);
                    });
                }
            }, []);

            if (!isConfigured) return <SetupScreen />;

            return (
                <div className="min-h-screen pb-10">
                    <Navbar user={user} onViewChange={setView} onOpenAdmin={() => setShowAdmin(true)} setViewUserId={setViewUserId} />
                    
                    {showAdmin && <AdminDashboard onClose={() => setShowAdmin(false)} />}
                    
                    {view === 'home' && <TopicList user={user} onViewChange={setView} setCurrentTopic={setCurrentTopic} setViewUserId={setViewUserId} selectedGuild={selectedGuild} setSelectedGuild={setSelectedGuild} />}
                    
                    {view === 'guilds' && <GuildList user={user} onViewChange={setView} setSelectedGuild={setSelectedGuild} />}
                    
                    {view === 'createGuild' && <CreateGuild user={user} onViewChange={setView} />}
                    
                    {view === 'create' && <CreateTopic user={user} onViewChange={setView} selectedGuild={selectedGuild} />}
                    
                    {view === 'thread' && currentTopic && <ThreadView user={user} topic={currentTopic} onViewChange={setView} setViewUserId={setViewUserId} />}
                    
                    {view === 'profile' && <ProfileView viewUserId={viewUserId} currentUser={user} onViewChange={setView} setCurrentTopic={setCurrentTopic} />}
                </div>
            );
        }
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>


