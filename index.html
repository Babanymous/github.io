<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BabaForum</title>
    
    <!-- Error Handler -->
    <script>
        window.onerror = function(msg, url, line) {
            // Ignore resize errors often caused by extensions
            if (msg.includes("ResizeObserver")) return;
            document.body.innerHTML = '<div style="color:red; padding:20px; background:black;"><h1>Error</h1><p>'+msg+'</p><p>Line: '+line+'</p></div>';
        };
    </script>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Segoe UI', sans-serif; }
        .glass-panel { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .btn-primary { background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%); transition: all 0.2s; }
        .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(168, 85, 247, 0.4); }
        .btn-outline { border: 1px solid #475569; color: #94a3b8; transition: all 0.2s; }
        .btn-outline:hover { border-color: #e2e8f0; color: #e2e8f0; background: rgba(255,255,255,0.05); }
        .prose a { color: #818cf8; text-decoration: underline; }
        .prose strong { color: white; font-weight: 700; }
        .prose code { background: #1e293b; padding: 2px 6px; rounded: 4px; font-family: monospace; color: #e2e8f0; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        // ==========================================
        const ADMIN_UID = "dqRRlIXKOIaVJDwEsWV1KeOQDgC3"; 
        const firebaseConfig = {
          apiKey: "AIzaSyDycl15CdloFo0LYcWQXwflBTfzscGjAIA",
          authDomain: "babaforum-500b9.firebaseapp.com",
          projectId: "babaforum-500b9",
          storageBucket: "babaforum-500b9.firebasestorage.app",
          messagingSenderId: "428963221608",
          appId: "1:428963221608:web:e284a66da91733d2e0abdd",
          measurementId: "G-F2ZTCCXPR2"
        };
        // ==========================================

        let app, auth, db;
        try {
            if (firebaseConfig.apiKey !== "YOUR_API_KEY_HERE") {
                app = firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                db = firebase.firestore();
            }
        } catch (e) { console.error(e); }

        const { useState, useEffect, useRef } = React;

        // --- COMPONENTS ---

        function SetupScreen() {
            return (
                <div className="min-h-screen flex items-center justify-center p-4 bg-slate-900">
                    <div className="glass-panel p-8 rounded-2xl text-center fade-in">
                        <i className="fa-solid fa-wrench text-indigo-400 text-3xl mb-4 block"></i>
                        <h1 className="text-2xl font-bold text-white mb-2">Setup Required</h1>
                        <p className="text-slate-400 mb-6">Please add your Firebase Keys to index.html</p>
                        <button onClick={() => window.location.reload()} className="btn-primary text-white px-6 py-2 rounded-lg">Refresh</button>
                    </div>
                </div>
            );
        }

        const ensureUserProfile = async (user) => {
            if(!user || !db) return;
            const userRef = db.collection('users').doc(user.uid);
            const doc = await userRef.get();
            if (!doc.exists) {
                await userRef.set({
                    displayName: user.displayName,
                    photoURL: user.photoURL,
                    bio: "Just joined BabaForum!",
                    followers: [],
                    following: [],
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
        };

        function RichText({ content }) {
            const getMarkdownText = () => {
                if (!window.marked) return { __html: content };
                const safeText = content.replace(/</g, "&lt;").replace(/>/g, "&gt;"); 
                return { __html: marked.parse(safeText) };
            };
            return <div className="prose text-slate-300 text-sm leading-relaxed" dangerouslySetInnerHTML={getMarkdownText()} />;
        }

        function ProfileView({ viewUserId, currentUser, onViewChange }) {
            const [profile, setProfile] = useState(null);
            const [posts, setPosts] = useState([]);
            const [isFollowing, setIsFollowing] = useState(false);
            const [editing, setEditing] = useState(false);
            const [newName, setNewName] = useState("");
            const [newBio, setNewBio] = useState("");

            useEffect(() => {
                const loadProfile = async () => {
                    if(!viewUserId) return;
                    const doc = await db.collection('users').doc(viewUserId).get();
                    if (doc.exists) {
                        const data = doc.data();
                        setProfile(data);
                        setNewName(data.displayName);
                        setNewBio(data.bio || "");
                        if (currentUser) {
                            const myDoc = await db.collection('users').doc(currentUser.uid).get();
                            const myData = myDoc.data();
                            setIsFollowing(myData?.following?.includes(viewUserId));
                        }
                    }
                    
                    // Load user's posts with Error Catching for Index
                    try {
                        const postsSnap = await db.collection('topics')
                            .where('authorId', '==', viewUserId)
                            .orderBy('createdAt', 'desc')
                            .limit(20)
                            .get();
                        setPosts(postsSnap.docs.map(d => ({id: d.id, ...d.data()})));
                    } catch (err) {
                        if(err.message.includes("index")) {
                            if(confirm("Missing Index! Click OK to create it in Firebase console.")) {
                                // Try to parse link from error
                                const match = err.message.match(/https:\/\/console\.firebase\.google\.com[^\s]*/);
                                if(match) window.open(match[0], '_blank');
                            }
                        } else {
                            console.error("Post load error:", err);
                        }
                    }
                };
                if(db && viewUserId) loadProfile();
            }, [viewUserId, currentUser]);

            const toggleFollow = async () => {
                if(!currentUser) return alert("Sign in to follow!");
                const myRef = db.collection('users').doc(currentUser.uid);
                const theirRef = db.collection('users').doc(viewUserId);
                const batch = db.batch();
                if(isFollowing) {
                    batch.update(myRef, { following: firebase.firestore.FieldValue.arrayRemove(viewUserId) });
                    batch.update(theirRef, { followers: firebase.firestore.FieldValue.arrayRemove(currentUser.uid) });
                } else {
                    batch.update(myRef, { following: firebase.firestore.FieldValue.arrayUnion(viewUserId) });
                    batch.update(theirRef, { followers: firebase.firestore.FieldValue.arrayUnion(currentUser.uid) });
                }
                await batch.commit();
                setIsFollowing(!isFollowing);
                setProfile(prev => ({...prev, followers: isFollowing ? prev.followers.slice(0,-1) : [...(prev.followers||[]), currentUser.uid] }));
            };

            const saveProfile = async () => {
                await db.collection('users').doc(currentUser.uid).update({ displayName: newName, bio: newBio });
                setProfile(prev => ({ ...prev, displayName: newName, bio: newBio }));
                setEditing(false);
            };

            if(!profile) return <div className="text-center p-10 text-slate-500">Loading Profile...</div>;
            const isMe = currentUser && currentUser.uid === viewUserId;

            return (
                <div className="max-w-4xl mx-auto p-4 fade-in">
                    <button onClick={() => onViewChange('home')} className="text-slate-400 mb-6 flex items-center gap-2"><i className="fa-solid fa-arrow-left"></i> Back</button>
                    <div className="glass-panel p-8 rounded-2xl mb-8 flex flex-col md:flex-row items-center md:items-start gap-6 text-center md:text-left">
                        <img src={profile.photoURL} className="w-24 h-24 rounded-full border-4 border-indigo-500/30 shadow-xl"/>
                        <div className="flex-1">
                            {editing ? (
                                <div className="space-y-3">
                                    <input className="w-full bg-slate-900 border border-slate-700 p-2 rounded text-white" value={newName} onChange={e=>setNewName(e.target.value)} placeholder="Display Name"/>
                                    <textarea className="w-full bg-slate-900 border border-slate-700 p-2 rounded text-white" value={newBio} onChange={e=>setNewBio(e.target.value)} placeholder="Bio"/>
                                    <div className="flex gap-2 justify-center md:justify-start">
                                        <button onClick={saveProfile} className="btn-primary px-4 py-1 rounded text-white text-sm">Save</button>
                                        <button onClick={()=>setEditing(false)} className="text-slate-400 text-sm">Cancel</button>
                                    </div>
                                </div>
                            ) : (
                                <>
                                    <h1 className="text-3xl font-bold text-white">{profile.displayName}</h1>
                                    <p className="text-indigo-300 mt-1 mb-4">{profile.bio}</p>
                                    <div className="flex gap-6 justify-center md:justify-start text-sm text-slate-400 mb-4">
                                        <span><strong className="text-white">{profile.followers?.length || 0}</strong> Followers</span>
                                        <span><strong className="text-white">{profile.following?.length || 0}</strong> Following</span>
                                    </div>
                                    {isMe ? <button onClick={()=>setEditing(true)} className="btn-outline px-4 py-2 rounded-lg text-sm">Edit Profile</button> : <button onClick={toggleFollow} className={`px-6 py-2 rounded-lg font-medium ${isFollowing ? 'bg-slate-700 text-slate-300' : 'btn-primary text-white'}`}>{isFollowing ? 'Following' : 'Follow'}</button>}
                                </>
                            )}
                        </div>
                    </div>
                    <h3 className="text-xl font-bold text-white mb-4">Recent Posts</h3>
                    <div className="space-y-3">
                        {posts.length === 0 && <div className="text-slate-500 text-sm italic">No posts yet (or index building...)</div>}
                        {posts.map(post => (<div key={post.id} className="glass-panel p-4 rounded-xl"><h4 className="text-lg font-semibold text-slate-200">{post.title}</h4><div className="text-slate-500 text-xs mt-2">{post.createdAt ? new Date(post.createdAt.seconds*1000).toLocaleDateString() : 'Just now'}</div></div>))}
                    </div>
                </div>
            );
        }

        function LikeButton({ user, docId, collection, likes, likedBy }) {
            const [isLiked, setIsLiked] = useState(false);
            const [count, setCount] = useState(likes || 0);
            useEffect(() => { if (user && likedBy?.includes(user.uid)) setIsLiked(true); }, [user, likedBy]);
            const handleLike = async (e) => {
                e.stopPropagation();
                if (!user) return alert("Please sign in to vote!");
                const docRef = db.collection(collection).doc(docId);
                const newStatus = !isLiked;
                setIsLiked(newStatus);
                setCount(prev => newStatus ? prev + 1 : prev - 1);
                try {
                    await docRef.update({
                        likes: firebase.firestore.FieldValue.increment(newStatus ? 1 : -1),
                        likedBy: newStatus ? firebase.firestore.FieldValue.arrayUnion(user.uid) : firebase.firestore.FieldValue.arrayRemove(user.uid)
                    });
                } catch (error) { setIsLiked(!newStatus); setCount(prev => newStatus ? prev - 1 : prev + 1); }
            };
            return (
                <button onClick={handleLike} className={`flex items-center gap-1 px-2 py-1 rounded-md ${isLiked ? 'text-pink-500 bg-pink-500/10' : 'text-slate-500 hover:bg-slate-700'}`}>
                    <i className={`${isLiked ? 'fa-solid' : 'fa-regular'} fa-heart`}></i>
                    <span className="text-xs font-bold">{count > 0 ? count : ''}</span>
                </button>
            );
        }

        function AdminDashboard({ onClose }) {
            const [stats, setStats] = useState({ topics: 0, replies: 0 });
            const [loading, setLoading] = useState(true);
            useEffect(() => {
                const fetchStats = async () => {
                    const t = await db.collection('topics').get();
                    const r = await db.collection('replies').get();
                    setStats({ topics: t.size, replies: r.size });
                    setLoading(false);
                };
                fetchStats();
            }, []);
            return (
                <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4 fade-in">
                    <div className="glass-panel p-8 rounded-2xl max-w-md w-full relative">
                        <button onClick={onClose} className="absolute top-4 right-4 text-slate-400 hover:text-white"><i className="fa-solid fa-xmark text-xl"></i></button>
                        <h2 className="text-2xl font-bold text-white mb-6"><i className="fa-solid fa-shield-halved text-indigo-500 mr-2"></i> Admin Panel</h2>
                        {loading ? <p className="text-slate-400">Loading...</p> : (
                            <div className="grid grid-cols-2 gap-4">
                                <div className="bg-slate-800 p-4 rounded-xl text-center border border-slate-700">
                                    <div className="text-3xl font-bold text-white">{stats.topics}</div>
                                    <div className="text-xs text-slate-400 uppercase">Topics</div>
                                </div>
                                <div className="bg-slate-800 p-4 rounded-xl text-center border border-slate-700">
                                    <div className="text-3xl font-bold text-white">{stats.replies}</div>
                                    <div className="text-xs text-slate-400 uppercase">Replies</div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        function Navbar({ user, onViewChange, onOpenAdmin, setViewUserId }) {
            const handleLogin = () => {
                if (!auth) return alert("Config Error");
                const provider = new firebase.auth.GoogleAuthProvider();
                auth.signInWithPopup(provider).catch(e => alert(e.message));
            };
            const isAdmin = user && user.uid === ADMIN_UID;
            return (
                <nav className="glass-panel sticky top-0 z-50 border-b border-slate-700/50">
                    <div className="max-w-6xl mx-auto px-4 h-16 flex items-center justify-between">
                        <div className="flex items-center gap-3 cursor-pointer" onClick={() => onViewChange('home')}>
                            <span className="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-white to-slate-400">BabaForum</span>
                        </div>
                        <div className="flex items-center gap-4">
                            {user ? (
                                <>
                                    {isAdmin && <button onClick={onOpenAdmin} className="bg-amber-500/20 hover:bg-amber-500/30 text-amber-400 px-3 py-1 rounded-lg text-xs font-bold border border-amber-500/30 transition-colors"><i className="fa-solid fa-lock mr-1"></i> Admin</button>}
                                    <button onClick={() => { setViewUserId(user.uid); onViewChange('profile'); }} className="flex items-center gap-2 hover:bg-slate-800 px-2 py-1 rounded transition-colors">
                                        <img src={user.photoURL} className="w-8 h-8 rounded-full border border-slate-600" /><span className="text-sm text-slate-300 hidden md:block">Me</span>
                                    </button>
                                    <button onClick={() => auth.signOut()} className="text-slate-400 hover:text-white"><i className="fa-solid fa-right-from-bracket"></i></button>
                                </>
                            ) : (
                                <button onClick={handleLogin} className="btn-primary text-white px-6 py-2 rounded-lg font-medium"><i className="fa-brands fa-google mr-2"></i>Sign In</button>
                            )}
                        </div>
                    </div>
                </nav>
            );
        }

        function TopicList({ user, onViewChange, setCurrentTopic, setViewUserId }) {
            const [topics, setTopics] = useState([]);
            const [loading, setLoading] = useState(true);
            const [search, setSearch] = useState("");
            const [filter, setFilter] = useState('all'); 
            const [followingList, setFollowingList] = useState([]);
            const isAdmin = user && user.uid === ADMIN_UID;

            useEffect(() => {
                if(user && db) {
                    db.collection('users').doc(user.uid).get().then(doc => { if(doc.exists) setFollowingList(doc.data().following || []); });
                }
                if(db) {
                    const unsubscribe = db.collection('topics').orderBy('createdAt', 'desc').onSnapshot(snap => {
                        const list = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                        list.sort((a, b) => (b.isPinned ? 1 : 0) - (a.isPinned ? 1 : 0) || b.createdAt - a.createdAt);
                        setTopics(list); setLoading(false);
                    });
                    return () => unsubscribe();
                }
            }, [user]);

            const displayTopics = topics.filter(t => {
                const matchesSearch = t.title.toLowerCase().includes(search.toLowerCase()) || t.content.toLowerCase().includes(search.toLowerCase());
                const matchesFilter = filter === 'all' || (filter === 'following' && followingList.includes(t.authorId));
                return matchesSearch && matchesFilter;
            });

            const goToProfile = (e, uid) => { e.stopPropagation(); setViewUserId(uid); onViewChange('profile'); };
            const deleteTopic = async (e, id) => { e.stopPropagation(); if(confirm("Delete?")) await db.collection('topics').doc(id).delete(); };
            const togglePin = async (e, topic) => { e.stopPropagation(); await db.collection('topics').doc(topic.id).update({ isPinned: !topic.isPinned }); };

            return (
                <div className="max-w-5xl mx-auto p-4 fade-in space-y-6">
                    <div className="flex flex-col md:flex-row gap-4 justify-between items-center">
                        <div className="flex gap-4 items-center w-full md:w-auto">
                            <h2 className="text-3xl font-bold text-white">Feed</h2>
                            {user && (<div className="flex bg-slate-800 rounded-lg p-1"><button onClick={()=>setFilter('all')} className={`px-3 py-1 rounded text-sm font-medium ${filter==='all'?'bg-slate-600 text-white':'text-slate-400'}`}>All</button><button onClick={()=>setFilter('following')} className={`px-3 py-1 rounded text-sm font-medium ${filter==='following'?'bg-indigo-500 text-white':'text-slate-400'}`}>Following</button></div>)}
                        </div>
                        <div className="flex gap-3 w-full md:w-auto">
                            <div className="relative flex-1 md:w-64"><i className="fa-solid fa-magnifying-glass absolute left-3 top-3 text-slate-500"></i><input type="text" value={search} onChange={(e) => setSearch(e.target.value)} placeholder="Search..." className="w-full bg-slate-800 border border-slate-700 rounded-xl pl-10 pr-4 py-2 text-white"/></div>
                            {user && <button onClick={() => onViewChange('create')} className="btn-primary text-white px-4 py-2 rounded-xl flex items-center gap-2 whitespace-nowrap"><i className="fa-solid fa-plus"></i> New</button>}
                        </div>
                    </div>
                    {loading ? <div className="text-slate-500 text-center">Loading...</div> : displayTopics.length === 0 ? <div className="text-center py-20 text-slate-500">No posts found.</div> :
                        displayTopics.map(topic => (
                        <div key={topic.id} onClick={() => {setCurrentTopic(topic); onViewChange('thread')}} className={`glass-panel p-5 rounded-xl cursor-pointer hover:bg-slate-800/80 flex gap-4 ${topic.isPinned ? 'border-l-4 border-amber-400' : ''}`}>
                            <div onClick={(e)=>goToProfile(e, topic.authorId)} className="flex-shrink-0 pt-1 cursor-pointer hover:opacity-80"><img src={topic.authorPhoto} className="w-10 h-10 rounded-full"/></div>
                            <div className="flex-1">
                                <div className="flex justify-between">
                                    <h3 className="text-lg font-semibold text-slate-200">{topic.title}</h3>
                                    <div className="flex gap-2">
                                        {isAdmin && <button onClick={(e)=>togglePin(e,topic)} className={`text-xs p-2 rounded ${topic.isPinned ? 'text-amber-400' : 'text-slate-600 hover:text-amber-400'}`}><i className="fa-solid fa-thumbtack"></i></button>}
                                        {(isAdmin || user?.uid === topic.authorId) && <button onClick={(e)=>deleteTopic(e,topic.id)} className="text-slate-500 hover:text-red-400"><i className="fa-solid fa-trash"></i></button>}
                                    </div>
                                </div>
                                <div className="text-slate-400 text-sm line-clamp-2 mt-1"><RichText content={topic.preview||""}/></div>
                                <div className="flex items-center gap-4 mt-3 text-xs text-slate-500">
                                    <span onClick={(e)=>goToProfile(e, topic.authorId)} className="hover:text-indigo-400 cursor-pointer font-medium">{topic.authorName}</span>
                                    <span>{topic.tag}</span>
                                    <div className="flex items-center gap-3 ml-auto">
                                        <LikeButton user={user} docId={topic.id} collection="topics" likes={topic.likes} likedBy={topic.likedBy} />
                                        <span><i className="fa-regular fa-comment-dots"></i> {topic.replyCount||0}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    ))}
                </div>
            );
        }

        function CreateTopic({ user, onViewChange }) {
            const [form, setForm] = useState({ title: '', content: '', tag: 'General' });
            const handleSubmit = async (e) => {
                e.preventDefault();
                await db.collection('topics').add({
                    ...form, preview: form.content.substring(0, 100)+'...', authorId: user.uid, authorName: user.displayName, authorPhoto: user.photoURL,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(), replyCount: 0, likes: 0, likedBy: [], isPinned: false
                });
                onViewChange('home');
            };
            return (
                <div className="max-w-2xl mx-auto p-4 fade-in">
                    <button onClick={() => onViewChange('home')} className="text-slate-400 mb-4"><i className="fa-solid fa-arrow-left"></i> Back</button>
                    <div className="glass-panel p-8 rounded-2xl">
                        <h2 className="text-2xl font-bold text-white mb-6">New Topic</h2>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <input className="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-3 text-white" placeholder="Title" value={form.title} onChange={e=>setForm({...form, title:e.target.value})} required />
                            <select className="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-3 text-white" value={form.tag} onChange={e=>setForm({...form, tag:e.target.value})}>
                                <option>General</option><option>Help</option><option>Showcase</option><option>Ideas</option>
                            </select>
                            <textarea className="w-full h-48 bg-slate-900 border border-slate-700 rounded-lg px-4 py-3 text-white" placeholder="Markdown supported..." value={form.content} onChange={e=>setForm({...form, content:e.target.value})} required />
                            <button type="submit" className="w-full btn-primary text-white py-3 rounded-xl font-bold">Post</button>
                        </form>
                    </div>
                </div>
            );
        }

        function ThreadView({ user, topic, onViewChange, setViewUserId }) {
            const [replies, setReplies] = useState([]);
            const [newReply, setNewReply] = useState('');
            const bottomRef = useRef(null);
            const isAdmin = user && user.uid === ADMIN_UID;
            useEffect(() => {
                if(!topic || !db) return;
                const unsub = db.collection('replies').where('topicId','==',topic.id).orderBy('createdAt','asc').onSnapshot(s => setReplies(s.docs.map(d=>({id:d.id, ...d.data()}))));
                return () => unsub();
            }, [topic]);
            const postReply = async (e) => {
                e.preventDefault(); if(!newReply.trim()) return;
                const batch = db.batch();
                batch.set(db.collection('replies').doc(), { content: newReply, topicId: topic.id, authorId: user.uid, authorName: user.displayName, authorPhoto: user.photoURL, createdAt: firebase.firestore.FieldValue.serverTimestamp(), likes: 0, likedBy: [] });
                batch.update(db.collection('topics').doc(topic.id), { replyCount: firebase.firestore.FieldValue.increment(1) });
                await batch.commit(); setNewReply(''); setTimeout(() => bottomRef.current?.scrollIntoView({behavior:'smooth'}), 100);
            };
            const deleteReply = async (id) => { if(confirm("Delete?")) { const b = db.batch(); b.delete(db.collection('replies').doc(id)); b.update(db.collection('topics').doc(topic.id), {replyCount: firebase.firestore.FieldValue.increment(-1)}); await b.commit(); }};
            return (
                <div className="max-w-4xl mx-auto p-4 h-screen flex flex-col fade-in">
                    <button onClick={() => onViewChange('home')} className="text-slate-400 mb-4 w-fit"><i className="fa-solid fa-arrow-left"></i> Back</button>
                    <div className="flex-1 overflow-y-auto space-y-6 pr-2 pb-20">
                        <div className="glass-panel p-6 rounded-2xl border-l-4 border-indigo-500">
                            <div className="flex items-center gap-3 mb-4 cursor-pointer" onClick={() => { setViewUserId(topic.authorId); onViewChange('profile'); }}>
                                <img src={topic.authorPhoto} className="w-10 h-10 rounded-full"/>
                                <div className="font-medium text-white hover:text-indigo-400">{topic.authorName}</div>
                            </div>
                            <h1 className="text-2xl font-bold text-white mb-4">{topic.title}</h1>
                            <RichText content={topic.content} />
                        </div>
                        {replies.map(r => (
                            <div key={r.id} className="glass-panel p-4 rounded-xl flex gap-4">
                                <div onClick={() => { setViewUserId(r.authorId); onViewChange('profile'); }} className="cursor-pointer"><img src={r.authorPhoto} className="w-8 h-8 rounded-full"/></div>
                                <div className="flex-1">
                                    <div className="flex justify-between items-center mb-2">
                                        <span className="font-medium text-indigo-300 mb-2 cursor-pointer" onClick={() => { setViewUserId(r.authorId); onViewChange('profile'); }}>{r.authorName}</span>
                                        <div className="flex gap-2 items-center">
                                            <LikeButton user={user} docId={r.id} collection="replies" likes={r.likes} likedBy={r.likedBy}/>
                                            {(isAdmin || user?.uid === r.authorId) && <button onClick={()=>deleteReply(r.id)} className="text-slate-600 hover:text-red-400"><i className="fa-solid fa-trash text-xs"></i></button>}
                                        </div>
                                    </div>
                                    <RichText content={r.content} />
                                </div>
                            </div>
                        ))}
                        <div ref={bottomRef}></div>
                    </div>
                    {user && <form onSubmit={postReply} className="bg-[#0f172a] pt-2 relative"><textarea value={newReply} onChange={e=>setNewReply(e.target.value)} className="w-full bg-slate-800 border border-slate-700 rounded-xl p-3 text-white" placeholder="Reply..." rows="2"/><button type="submit" className="absolute right-3 bottom-3 text-indigo-400"><i className="fa-solid fa-paper-plane"></i></button></form>}
                </div>
            );
        }

        function App() {
            const [view, setView] = useState('home'); // home, create, thread, profile
            const [user, setUser] = useState(null);
            const [currentTopic, setCurrentTopic] = useState(null);
            const [viewUserId, setViewUserId] = useState(null); // For profile view
            const [isConfigured, setIsConfigured] = useState(false);
            const [showAdmin, setShowAdmin] = useState(false);

            useEffect(() => {
                if (firebaseConfig.apiKey !== "YOUR_API_KEY_HERE") {
                    setIsConfigured(true);
                    return auth.onAuthStateChanged(async (u) => {
                        if(u) await ensureUserProfile(u);
                        setUser(u);
                    });
                }
            }, []);

            if (!isConfigured) return <SetupScreen />;
            return (
                <div className="min-h-screen pb-10">
                    <Navbar user={user} onViewChange={setView} onOpenAdmin={() => setShowAdmin(true)} setViewUserId={setViewUserId} />
                    {showAdmin && <AdminDashboard onClose={() => setShowAdmin(false)} />}
                    {view === 'home' && <TopicList user={user} onViewChange={setView} setCurrentTopic={setCurrentTopic} setViewUserId={setViewUserId} />}
                    {view === 'create' && user && <CreateTopic user={user} onViewChange={setView} />}
                    {view === 'thread' && currentTopic && <ThreadView user={user} topic={currentTopic} onViewChange={setView} setViewUserId={setViewUserId} />}
                    {view === 'profile' && <ProfileView viewUserId={viewUserId} currentUser={user} onViewChange={setView} />}
                </div>
            );
        }
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>


